name: ğŸš€ Deploy Node.js with HTTPS

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      project_url:
        description: 'GitHub URL of Node.js project to deploy'
        required: false
        default: ''

env:
  NODE_PROJECT_URL_TO_DEPLOY: ${{ secrets.NODE_PROJECT_URL_TO_DEPLOY || github.event.inputs.project_url }}
  APP_NAME: nodejs-app
  APP_DIR: /home/${{ secrets.SSH_USER }}/apps/nodejs-app
  APP_PORT: 3000
  NODE_VERSION: 20
  DOMAIN: ${{ secrets.DOMAIN }}
  SSL_EMAIL: ${{ secrets.SSL_EMAIL }}

jobs:
  deploy:
    name: Setup & Deploy with HTTPS
    runs-on: ubuntu-latest
    
    steps:
      - name: âœ… Validate Configuration
        run: |
          echo "Validating required environment variables..."
          
          if [ -z "${{ env.NODE_PROJECT_URL_TO_DEPLOY }}" ]; then
            echo "âŒ ERROR: NODE_PROJECT_URL_TO_DEPLOY is not set!"
            exit 1
          fi
          
          if [ -z "${{ secrets.SSH_HOST }}" ]; then
            echo "âŒ ERROR: SSH_HOST secret is not set!"
            exit 1
          fi
          
          if [ -z "${{ secrets.SSH_USER }}" ]; then
            echo "âŒ ERROR: SSH_USER secret is not set!"
            exit 1
          fi
          
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ ERROR: SSH_PRIVATE_KEY secret is not set!"
            exit 1
          fi
          
          echo "âœ… All required variables are set!"
          echo "ğŸ“¦ Project: ${{ env.NODE_PROJECT_URL_TO_DEPLOY }}"
          echo "ğŸ–¥ï¸  Host: ${{ secrets.SSH_HOST }}"
          
          if [ -n "${{ env.DOMAIN }}" ]; then
            echo "ğŸ” Domain: ${{ env.DOMAIN }}"
            echo "ğŸ”’ HTTPS will be configured"
          else
            echo "âš ï¸  No domain - HTTP only"
          fi

      - name: ğŸ› ï¸ Setup VM Environment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            set -e
            
            echo "ğŸš€ Starting VM Setup..."
            
            sudo apt-get update
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
              curl wget git build-essential ufw
            
            # Node.js
            if ! command -v node &> /dev/null; then
              echo "ğŸ“¦ Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_${{ env.NODE_VERSION }}.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            
            # PM2
            if ! command -v pm2 &> /dev/null; then
              sudo npm install -g pm2
            fi
            
            # Nginx
            if ! command -v nginx &> /dev/null; then
              sudo apt-get install -y nginx
            fi
            
            # Certbot
            if [ -n "${{ env.DOMAIN }}" ]; then
              if ! command -v certbot &> /dev/null; then
                echo "ğŸ“¦ Installing Certbot..."
                sudo apt-get install -y certbot python3-certbot-nginx
              fi
            fi
            
            # Firewall
            sudo ufw --force reset
            sudo ufw default deny incoming
            sudo ufw default allow outgoing
            sudo ufw allow 22/tcp
            sudo ufw allow 80/tcp
            sudo ufw allow 443/tcp
            sudo ufw --force enable
            
            mkdir -p ${{ env.APP_DIR }}
            pm2 startup systemd -u ${{ secrets.SSH_USER }} --hp /home/${{ secrets.SSH_USER }} | grep "sudo" | sudo bash || true
            
            echo "âœ… VM Setup Complete!"

      - name: ğŸ“¥ Clone and Setup Application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            set -e
            cd ${{ env.APP_DIR }}
            
            if [ -d ".git" ]; then
              cd .. && rm -rf ${{ env.APP_DIR }}
              mkdir -p ${{ env.APP_DIR }}
              cd ${{ env.APP_DIR }}
            fi
            
            git clone ${{ env.NODE_PROJECT_URL_TO_DEPLOY }} .
            
            if [ -f "package-lock.json" ]; then
              npm ci --production
            else
              npm install --production
            fi
            
            if grep -q '"build"' package.json 2>/dev/null; then
              npm run build || true
            fi

      - name: ğŸ” Configure Application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            cd ${{ env.APP_DIR }}
            mkdir -p logs
            
            node <<'NODESCRIPT'
            const fs = require('fs');
            const config = {
              apps: [{
                name: 'nodejs-app',
                instances: 1,
                autorestart: true,
                watch: false,
                max_memory_restart: '500M',
                env: { NODE_ENV: 'production', PORT: 3000 },
                error_file: './logs/err.log',
                out_file: './logs/out.log',
                log_date_format: 'YYYY-MM-DD HH:mm:ss'
              }]
            };
            
            try {
              const pkg = require('./package.json');
              if (pkg.scripts?.start) {
                config.apps[0].script = 'npm';
                config.apps[0].args = 'start';
              } else if (pkg.main) {
                config.apps[0].script = pkg.main;
              } else {
                const entry = ['index.js', 'server.js', 'app.js', 'src/index.js'].find(f => fs.existsSync(f));
                config.apps[0].script = entry || 'index.js';
              }
            } catch (e) {
              config.apps[0].script = 'index.js';
            }
            
            fs.writeFileSync('ecosystem.config.js', 
              'module.exports = ' + JSON.stringify(config, null, 2) + ';'
            );
            NODESCRIPT

      - name: ğŸŒ Configure Nginx for HTTPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            
            DOMAIN="${{ env.DOMAIN }}"
            
            if [ -n "$DOMAIN" ]; then
              echo "ğŸŒ Configuring Nginx for domain: $DOMAIN"
              
              # Initial HTTP-only config (Certbot will modify for HTTPS)
              sudo tee /etc/nginx/sites-available/nodejs-app > /dev/null <<EOF
            server {
                listen 80;
                listen [::]:80;
                server_name $DOMAIN www.$DOMAIN;
                
                location / {
                    proxy_pass http://localhost:3000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                    proxy_cache_bypass \$http_upgrade;
                }
            }
            EOF
            else
              echo "ğŸ“ Configuring Nginx for IP (HTTP only)"
              
              sudo tee /etc/nginx/sites-available/nodejs-app > /dev/null <<'EOF'
            server {
                listen 80 default_server;
                listen [::]:80 default_server;
                server_name _;
                
                location / {
                    proxy_pass http://localhost:3000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host $host;
                    proxy_cache_bypass $http_upgrade;
                }
            }
            EOF
            fi
            
            sudo ln -sf /etc/nginx/sites-available/nodejs-app /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo nginx -t
            sudo systemctl restart nginx
            sudo systemctl enable nginx

      - name: ğŸš€ Start Application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            cd ${{ env.APP_DIR }}
            
            pm2 delete nodejs-app 2>/dev/null || true
            pm2 start ecosystem.config.js
            pm2 save
            sleep 5
            pm2 status

      - name: ğŸ¥ Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "ğŸ¥ Health check..."
            sleep 10
            
            for i in {1..15}; do
              if curl -f -s http://localhost:3000 > /dev/null 2>&1; then
                echo "âœ… App is healthy!"
                break
              fi
              sleep 3
            done

      - name: ğŸ”’ Setup SSL Certificate (Let's Encrypt)
        if: env.DOMAIN != ''
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e
            
            DOMAIN="${{ env.DOMAIN }}"
            EMAIL="${{ env.SSL_EMAIL }}"
            
            # Default email if not provided
            [ -z "$EMAIL" ] && EMAIL="admin@$DOMAIN"
            
            echo "========================================"
            echo "ğŸ”’ SETTING UP SSL CERTIFICATE"
            echo "========================================"
            echo "Domain: $DOMAIN"
            echo "Email: $EMAIL"
            echo ""
            
            # Verify DNS resolution first
            echo "ğŸ” Verifying DNS..."
            RESOLVED_IP=$(dig +short $DOMAIN | tail -n1)
            CURRENT_IP=$(curl -s ifconfig.me)
            
            echo "Domain resolves to: $RESOLVED_IP"
            echo "Server IP: $CURRENT_IP"
            
            if [ "$RESOLVED_IP" != "$CURRENT_IP" ]; then
              echo "âš ï¸  WARNING: DNS mismatch!"
              echo "Your domain points to: $RESOLVED_IP"
              echo "But your server IP is: $CURRENT_IP"
              echo ""
              echo "Attempting SSL setup anyway..."
            fi
            
            # Stop Nginx temporarily for standalone verification
            echo "â¸ï¸  Stopping Nginx temporarily..."
            sudo systemctl stop nginx
            
            # Get certificate using standalone mode
            echo "ğŸ“œ Obtaining SSL certificate..."
            
            sudo certbot certonly \
              --standalone \
              --non-interactive \
              --agree-tos \
              --email "$EMAIL" \
              --preferred-challenges http \
              -d "$DOMAIN" 2>&1 | tee /tmp/certbot.log
            
            CERTBOT_EXIT_CODE=${PIPESTATUS[0]}
            
            if [ $CERTBOT_EXIT_CODE -eq 0 ]; then
              echo "âœ… Certificate obtained successfully!"
              
              # Now configure Nginx with SSL
              echo "ğŸ” Configuring Nginx for HTTPS..."
              
              sudo tee /etc/nginx/sites-available/nodejs-app > /dev/null <<EOF
            # HTTP - Redirect to HTTPS
            server {
                listen 80;
                listen [::]:80;
                server_name $DOMAIN www.$DOMAIN;
                
                return 301 https://\$server_name\$request_uri;
            }
            
            # HTTPS
            server {
                listen 443 ssl http2;
                listen [::]:443 ssl http2;
                server_name $DOMAIN www.$DOMAIN;
                
                # SSL Configuration
                ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;
                
                # SSL Settings
                ssl_protocols TLSv1.2 TLSv1.3;
                ssl_ciphers HIGH:!aNULL:!MD5;
                ssl_prefer_server_ciphers off;
                
                # SSL Session
                ssl_session_cache shared:SSL:10m;
                ssl_session_timeout 10m;
                
                # Security Headers
                add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
                add_header X-Frame-Options "SAMEORIGIN" always;
                add_header X-Content-Type-Options "nosniff" always;
                add_header X-XSS-Protection "1; mode=block" always;
                
                location / {
                    proxy_pass http://localhost:3000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                    proxy_cache_bypass \$http_upgrade;
                }
            }
            EOF
              
              # Start Nginx
              sudo nginx -t
              sudo systemctl start nginx
              
              # Setup auto-renewal
              echo "ğŸ”„ Setting up auto-renewal..."
              sudo systemctl enable certbot.timer
              sudo systemctl start certbot.timer
              
              echo ""
              echo "âœ… SSL SETUP COMPLETE!"
              echo "ğŸ”’ Your site is now accessible via HTTPS"
              echo "ğŸ”„ Certificate auto-renews every 90 days"
              
            else
              echo ""
              echo "âŒ CERTIFICATE SETUP FAILED"
              echo "========================================"
              cat /tmp/certbot.log
              echo "========================================"
              echo ""
              echo "Common issues:"
              echo "1. DNS not pointing to this server"
              echo "2. Firewall blocking port 80"
              echo "3. Domain not propagated yet"
              echo ""
              echo "Reverting to HTTP..."
              
              # Revert to HTTP config
              sudo tee /etc/nginx/sites-available/nodejs-app > /dev/null <<EOF
            server {
                listen 80;
                listen [::]:80;
                server_name $DOMAIN www.$DOMAIN;
                
                location / {
                    proxy_pass http://localhost:3000;
                    proxy_http_version 1.1;
                    proxy_set_header Host \$host;
                    proxy_cache_bypass \$http_upgrade;
                }
            }
            EOF
              
              sudo nginx -t
              sudo systemctl start nginx
              
              echo "âš ï¸  Site running on HTTP only"
            fi

      - name: ğŸ‰ Display Live URLs
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            DOMAIN="${{ env.DOMAIN }}"
            
            echo ""
            echo "========================================"
            echo "âœ… DEPLOYMENT SUCCESSFUL!"
            echo "========================================"
            echo ""
            
            if [ -n "$DOMAIN" ]; then
              # Check if SSL is configured
              if [ -f "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" ]; then
                echo "ğŸŒ YOUR LIVE WEBSITE (HTTPS):"
                echo "========================================"
                echo ""
                echo "   ğŸ”’ https://$DOMAIN"
                echo ""
                echo "========================================"
                echo ""
                echo "âœ… SSL: Active and Auto-Renewing"
                echo "ğŸ” HTTPS: Enabled"
                echo "â†ªï¸  HTTP: Redirects to HTTPS"
                echo ""
                
                # Test HTTPS
                echo "ğŸ§ª Testing HTTPS connection..."
                if curl -ksf https://$DOMAIN > /dev/null 2>&1; then
                  echo "âœ… HTTPS is working perfectly!"
                else
                  echo "âš ï¸  HTTPS may take a few seconds to activate"
                fi
              else
                echo "ğŸŒ YOUR LIVE WEBSITE (HTTP):"
                echo "========================================"
                echo ""
                echo "   ğŸ”— http://$DOMAIN"
                echo ""
                echo "========================================"
                echo ""
                echo "âš ï¸  SSL setup incomplete - HTTP only"
                echo ""
                echo "To fix:"
                echo "1. Wait 5 minutes for DNS propagation"
                echo "2. Verify: ping $DOMAIN"
                echo "3. Re-run deployment"
              fi
            else
              echo "ğŸŒ YOUR LIVE WEBSITE:"
              echo "========================================"
              echo ""
              echo "   ğŸ”— http://${{ secrets.SSH_HOST }}"
              echo ""
              echo "========================================"
              echo ""
              echo "ğŸ’¡ To enable HTTPS:"
              echo "   1. Get domain: duckdns.org"
              echo "   2. Add DOMAIN secret"
              echo "   3. Add SSL_EMAIL secret"
              echo "   4. Redeploy"
            fi
            
            echo ""
            echo "ğŸ“Š Status:"
            pm2 status | grep nodejs-app
            echo ""
            echo "========================================"

      - name: ğŸ“¢ Final Console Output - LIVE URL
        run: |
          DOMAIN="${{ env.DOMAIN }}"
          
          echo ""
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                    â•‘"
          echo "â•‘        ğŸ‰ DEPLOYMENT COMPLETED! ğŸ‰                â•‘"
          echo "â•‘                                                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          if [ -n "$DOMAIN" ]; then
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚                                                    â”‚"
            echo "â”‚  ğŸŒ YOUR WEBSITE IS LIVE AND ACCESSIBLE:         â”‚"
            echo "â”‚                                                    â”‚"
            echo "â”‚      ğŸ”’ https://$DOMAIN"
            echo "â”‚                                                    â”‚"
            echo "â”‚  âœ… HTTPS Enabled (Let's Encrypt)                 â”‚"
            echo "â”‚  âœ… Auto-Renewing SSL Certificate                 â”‚"
            echo "â”‚  âœ… Accessible from Anywhere on Internet          â”‚"
            echo "â”‚                                                    â”‚"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          else
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚                                                    â”‚"
            echo "â”‚  ğŸŒ YOUR WEBSITE IS LIVE:                         â”‚"
            echo "â”‚                                                    â”‚"
            echo "â”‚      ğŸ”— http://${{ secrets.SSH_HOST }}"
            echo "â”‚                                                    â”‚"
            echo "â”‚  âš ï¸  HTTP Only (No HTTPS)                         â”‚"
            echo "â”‚                                                    â”‚"
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""
            echo "ğŸ’¡ To enable HTTPS (FREE):"
            echo "   1. Visit: https://duckdns.org"
            echo "   2. Create domain: yourapp.duckdns.org"
            echo "   3. Add GitHub Secrets:"
            echo "      - DOMAIN: yourapp.duckdns.org"
            echo "      - SSL_EMAIL: your@email.com"
            echo "   4. Push code again"
          fi
          
          echo ""
          echo "ğŸ“ Deployment Details:"
          echo "   Repository: ${{ env.NODE_PROJECT_URL_TO_DEPLOY }}"
          echo "   Server: ${{ secrets.SSH_HOST }}"
          echo "   App: ${{ env.APP_NAME }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
